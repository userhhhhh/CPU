# <img src="README.assets/cpu.png" width="40" align=center /> RISCV-CPU 2022

## å¼•è¨€

![wechat_screenshot](README.assets/wechat_screenshot.jpg)





## é¡¹ç›®è¯´æ˜

åœ¨æœ¬é¡¹ç›®ä¸­ï¼Œä½ éœ€è¦ä½¿ç”¨ Verilog è¯­è¨€å®Œæˆä¸€ä¸ªç®€å•çš„ RISC-V CPU ç”µè·¯è®¾è®¡ã€‚Verilog ä»£ç ä¼šä»¥è½¯ä»¶ä»¿çœŸå’Œ FPGA æ¿ä¸¤ç§æ–¹å¼è¿è¡Œã€‚ä½ è®¾è®¡çš„ç”µè·¯å°†è¿è¡Œè‹¥å¹²æµ‹è¯•ç¨‹åºå¹¶å¯èƒ½æœ‰è¾“å…¥æ•°æ®ï¼Œæ‰§è¡Œå¾—åˆ°çš„è¾“å‡ºæ•°æ®å°†ä¸æœŸæœ›ç»“æœæ¯”è¾ƒï¼Œä»è€Œåˆ¤å®šä½ çš„ Verilog ä»£ç çš„æ­£ç¡®æ€§ã€‚ä½ éœ€è¦å®ç° CPU çš„è¿ç®—å™¨ä¸æ§åˆ¶å™¨ï¼Œè€Œå†…å­˜ç­‰éƒ¨ä»¶é¢˜é¢å·²æä¾›ä»£ç ã€‚



### é¡¹ç›®é˜¶æ®µ

- å®Œæˆ Speculative CPU æ‰€æ”¯æŒçš„æ‰€æœ‰æ¨¡å—

- åœ¨æœ¬åœ° Simulation é€šè¿‡å¯æ‰§è¡Œçš„æµ‹è¯•

  >  åœ¨æœ¬åœ° Simulation æ—¶ï¼Œéƒ¨åˆ†æ ·ä¾‹è¿è¡Œæ—¶é—´å¯èƒ½ä¼šéå¸¸éå¸¸é•¿ï¼Œå¦‚ `heart.c` ä¸ `pi.c`ã€‚è¿™äº›æ ·ä¾‹ä¸ä¼šè¢«ç®—å…¥ Simulation çš„æµ‹è¯•èŒƒå›´ï¼Œä½†ä¼šåœ¨ FPGA æ£€æŸ¥é˜¶æ®µçº³å…¥æµ‹è¯•èŒƒå›´ã€‚

- åœ¨ FPGA ä¸Šé€šè¿‡æ‰€æœ‰æµ‹è¯•



### æ—¶é—´å®‰æ’

> æ—¶é—´ä»¥ä¸Šæµ·äº¤é€šå¤§å­¦ 2024-2025 å­¦å¹´æ ¡å†ä¸ºå‡†ï¼ŒWeek 5 å‘¨ä¸€ä¸º 2024.10.14

æ¯ 3 å‘¨ä¸€æ¬¡æ£€æŸ¥ï¼Œæ£€æŸ¥æ—¶é—´ä¸ºæ¯å‘¨æ—¥ 22:00 åï¼Œä¸‹è¡¨ä¸ºæ£€æŸ¥å½¢å¼ä¸æ ‡å‡†ï¼š

| æ—¶é—´        | æ£€æŸ¥å†…å®¹                                     |
| ----------- | -------------------------------------------- |
| **Week 5**  | ä»“åº“åˆ›å»º                                     |
| **Week 7**  | å®Œæˆç”µè·¯è®¾è®¡è‰ç¨¿ / å„ä¸ª CPU æ¨¡å—æ–‡ä»¶åˆ›å»º     |
| **Week 10** | å„ä¸ª CPU æ¨¡å—æ–‡ä»¶åŸºæœ¬å®Œæˆï¼Œå®Œæˆ `cpu.v` è¿çº¿ |
| **Week 13** | Simulation é€šè¿‡æ‰€æœ‰æµ‹è¯•ç‚¹                    |
| **Week 16** | FPGA é€šè¿‡æ‰€æœ‰æµ‹è¯•ç‚¹                          |



### æœ€ç»ˆæäº¤

ä½ éœ€è¦åœ¨github releaseä¸­ä¸Šä¼ ç”± Vivado Synthesis ç”Ÿæˆå‡ºçš„ `.bit` æ–‡ä»¶ï¼Œæˆªæ­¢æ—¶é—´ä¸ºç¬¬ 16 å‘¨å‰ï¼ˆ2025.1.5 23:59ï¼‰ã€‚



### åˆ†æ•°æ„æˆ

æœ¬ä½œä¸šæ»¡åˆ†ä¸º 100%ã€‚

| è¯„åˆ†é¡¹ç›®        | åˆ†æ•° | è¯´æ˜                                     |
| --------------- | ---- | ---------------------------------------- |
| **ä»¿çœŸæµ‹è¯•**    | 60%  | é€šè¿‡æ‰€æœ‰ä»¿çœŸæµ‹è¯•ç‚¹                       |
| **FPGA æµ‹è¯•**   | 20%  | é€šè¿‡æ‰€æœ‰ FPGA æµ‹è¯•ç‚¹                     |
| **Code Review** | 20%  | ä»¥é¢è°ˆå½¢å¼è€ƒå¯Ÿ CPU åŸç†ä¸ HDL çš„ç†è§£æŒæ¡ |





## å®ç°è¯´æ˜

### ä»“åº“æ–‡ä»¶ç»“æ„

```C++
ğŸ“¦RISCV-CPU
â”£ ğŸ“‚fpga			// FPGA å¼€å‘æ¿ç›¸å…³
â”£ ğŸ“‚script		// ç¼–è¯‘æµ‹è¯•ç›¸å…³å‚è€ƒè„šæœ¬
â”£ ğŸ“‚sim			// ä»¿çœŸè¿è¡Œ Testbench
â”£ ğŸ“‚src			// HDL æºä»£ç 
â”ƒ â”£ ğŸ“‚common			// é¢˜é¢æä¾›éƒ¨ä»¶æºä»£ç 
â”ƒ â”£ ğŸ“œcpu.v			// CPU æ ¸å¿ƒä»£ç 
â”£ ğŸ“‚testcase		// æµ‹è¯•ç‚¹
â”ƒ â”£ ğŸ“‚fpga			// å…¨éƒ¨æµ‹è¯•ç‚¹ 
â”ƒ â”— ğŸ“‚sim			// ä»¿çœŸè¿è¡Œæµ‹è¯•ç‚¹
â”£ ğŸ“‚testspace	// ç¼–è¯‘è¿è¡Œç»“æœ
â”£ ğŸ“œMakefile		// ç¼–è¯‘åŠæµ‹è¯•è„šæœ¬
â”— ğŸ“œREADME.md	// é¢˜é¢æ–‡æ¡£
```

### æ¦‚è¿°

1. æ ¹æ® [`riscv/src/cpu.v`](https://github.com/ACMClassCourses/RISCV-CPU/blob/main/riscv/src/cpu.v) æä¾›çš„æ¥å£è‡ªé¡¶å‘ä¸‹å®Œæˆä»£ç ï¼Œå…¶ä½™é¢˜é¢ä»£ç å°½é‡ä¸è¦æ”¹åŠ¨
2. è®¾è®¡å¹¶å®ç°**æ”¯æŒä¹±åºæ‰§è¡Œ**çš„ Tomasulo æ¶æ„ CPU
3. ä½¿ç”¨ iVerilog è¿›è¡Œæœ¬åœ°ä»¿çœŸæµ‹è¯•ï¼ˆç»“æœä¸º `.vcd` æ–‡ä»¶ï¼‰
4. ä¾ç…§åŠ©æ•™å®‰æ’ï¼Œå°† Verilog ä»£ç çƒ§å½•è‡³ FPGA æ¿ä¸Šè¿›è¡Œæ‰€æœ‰æµ‹è¯•æ•°æ®çš„æµ‹è¯•

### æŒ‡ä»¤é›†

> å¯å‚è€ƒèµ„æ–™è§ [RISC-V æŒ‡ä»¤é›†](#RISC-V-æŒ‡ä»¤é›†)

æœ¬é¡¹ç›®ä½¿ç”¨ **RV32IC æŒ‡ä»¤é›†**

åŸºç¡€æµ‹è¯•å†…å®¹ä¸åŒ…æ‹¬ Doubleword å’Œ Word ç›¸å…³æŒ‡ä»¤ã€Environment ç›¸å…³æŒ‡ä»¤å’Œ CSR ç›¸å…³ç­‰æŒ‡ä»¤ã€‚

å¿…é¡»è¦å®ç°çš„æŒ‡ä»¤ä¸ºä»¥ä¸‹ 37 ä¸ªï¼š`LUI`, `AUIPC`, `JAL`, `JALR`, `BEQ`, `BNE`, `BLT`, `BGE`, `BLTU`, `BGEU`, `LB`, `LH`, `LW`, `LBU`, `LHU`, `SB`, `SH`, `SW`, `ADDI`, `SLLI`, `SLTI`, `SLTIU`, `XORI`, `SRLI`, `SRAI`, `ORI`, `ANDI`, `ADD`, `SUB`, `SLL`, `SLT`, `SLTU`, `XOR`, `SRL`, `SRA`, `OR`, `AND`



## å¸®åŠ©

> **è¿™å¯èƒ½å¯¹ä½ æ¥è¯´éå¸¸é‡è¦ã€‚**

### æ–‡æ¡£

- Vivado ä¸æ”¯æŒ MacOS ç³»ç»Ÿï¼Œæ•…å¦‚æœä½¿ç”¨ Mac åˆ™å¿…é¡»ä½¿ç”¨è™šæ‹Ÿæœºï¼Œæ¨è Ubuntu Desktopã€‚æ­¤å¤–å¯¹äºä½¿ç”¨ Windows ç”µè„‘çš„åŒå­¦ï¼ŒRISC-V Toolchain ä¹Ÿæ¨èåœ¨ Linux ç³»ç»Ÿä¸Šå®‰è£…ã€‚
- å…³äºRISCV Cæ‹“å±•çš„ç›¸å…³çŸ¥è¯†ï¼Œå¤§å®¶å¯ä»¥å‚è€ƒcanvasä¸Šç›¸å…³ä¹¦ç± å’Œ RISCVå®˜æ–¹æ–‡æ¡£ï¼ˆhttps://riscv.org/technical/specifications/ï¼‰



### Q & A

1. **æˆ‘çš„ CPU ä¼šä»å“ªé‡Œè¯»å–æŒ‡ä»¤å¹¶æ‰§è¡Œï¼Ÿ**

   ä» `0x0000000` åœ°å€å¤„å¼€å§‹æ‰§è¡Œã€‚

2. **æˆ‘çš„ CPU å¦‚ä½•åœæœºï¼Ÿ**

   è§ `cpu.v` ä¸­ `Specification` éƒ¨åˆ†ã€‚

3. **æˆ‘çš„å¯„å­˜å™¨å †ï¼ˆRegister Fileï¼‰éœ€è¦å¤šå°‘ä¸ªå¯„å­˜å™¨ï¼Ÿ**

   Unprivileged CPU: 32ï¼›

   Privileged CPU: 32 + 8 (CSR)ã€‚

4. **æ‰˜é©¬æ–¯æ´›ç®—æ³•å¹¶æ²¡æœ‰ç¡¬ä»¶å®ç°çš„å…¬è®¤å”¯ä¸€æ ‡å‡†ï¼Œé‚£ä¹ˆæœ¬é¡¹ç›®æœ‰ä»€ä¹ˆç‰¹æ®Šè¦æ±‚å—ï¼Ÿ**

   æ‰˜é©¬æ–¯æ´›çš„è¦æ±‚å¯å‚è€ƒ [Wikipedia](https://en.wikipedia.org/wiki/Tomasulo%27s_algorithm#Instruction_lifecycle)ï¼Œå³æ‰§è¡Œä¸€æ¡æŒ‡ä»¤éœ€è¦æ¶‰åŠ *Issue*ã€*Execute*ã€*Write Result* ä¸‰æ­¥éª¤ã€‚æ­¤å¤–ï¼Œ**å¿…é¡»è¦å®ç° *Instruction Cache*** ä»¥ç¡®ä¿ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ä¼šå‡ºç°å¤šæ¡æŒ‡ä»¤çš„ lifecycle é‡å çš„æƒ…å†µã€‚

5. **æˆ‘è¯¥å¦‚ä½•å¼€å§‹è¿è¡Œä»£ç ï¼Ÿ**

   åœ¨ `riscv/` è·¯å¾„ä¸‹è¿è¡Œ `make test_sim name=000` æŒ‡ä»¤å³å¯è‡ªåŠ¨ç¼–è¯‘å¹¶è¿è¡Œç¬¬ä¸€ä¸ªä»¿çœŸæµ‹è¯•ç‚¹ï¼Œæµ‹è¯•æ–‡ä»¶å‡åœ¨ `riscv/testspace/` æ–‡ä»¶å¤¹ä¸­ã€‚

6. **`io_buffer_full`?**

   ç”¨äºæŒ‡ç¤ºå½“å‰ ram çš„ io buffer æ˜¯å¦å·²æ»¡ã€‚è‹¥å·²æ»¡ï¼Œå¯èƒ½ä¼šå‡ºç° overwrite / lossã€‚

   æ³¨æ„ï¼šæ­¤ä¿¡å·åœ¨ simulation éƒ¨åˆ†å§‹ç»ˆä¸º low (false)ï¼Œä½†åœ¨ FPGA ä¸Šä¼šæœ‰é«˜ä½å˜åŒ–ã€‚

7. **`in_rdy`?**

   ç”¨äºæŒ‡ç¤ºå½“å‰hciæ€»çº¿æ˜¯å¦ä¸ºactive (å¯å·¥ä½œ)ï¼Œè‹¥å¦ï¼Œåˆ™cpuåº”å½“pauseã€‚

8. **è¿è¡Œæµ‹è¯•è¿‡ç¨‹ä¸­ build æŠ¥é”™ï¼Ÿ**

   è¯·è€ƒè™‘ä»¥ä¸‹å‡ ç‚¹ï¼š

   - ç›®å½•é”™è¯¯

     è„šæœ¬è¿è¡Œç›®å½•åº”å½“ä¸º `riscv/` æ–‡ä»¶å¤¹

   - ç¯å¢ƒç¼ºå¤±ï¼Œå¦‚ `cannot find module -lgcc ...`

     **åœ¨é…ç½®äº†riscv-toolchains çš„ç¯å¢ƒä¸‹ï¼Œåº”å½“å¯ä»¥æ­£å¸¸ buildã€‚**

     **è¯·æ£€æŸ¥è¿æ¥äº† FPGA çš„ç³»ç»Ÿæ˜¯å¦é…ç½®äº† riscv-toolchainsï¼Œè‹¥æ²¡æœ‰ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ç°æˆçš„ç¼–è¯‘ç»“æœã€‚**

9. **To be continued...**





----

> ä»¥ä¸‹ä¸ºé™„å½•å†…å®¹ã€‚





## é™„å½• A

### RISC-V æŒ‡ä»¤é›†

- å®˜ç½‘ https://riscv.org/
- [å®˜æ–¹æ–‡æ¡£ä¸‹è½½é¡µé¢](https://riscv.org/technical/specifications/)
  - åŸºç¡€å†…å®¹è§ Volume 1, Unprivileged Spec
  - ç‰¹æƒæŒ‡ä»¤é›†è§ Volume 2, Privileged Spec
- éå®˜æ–¹ [Read the Docs æ–‡æ¡£](https://msyksphinz-self.github.io/riscv-isadoc/html/index.html)

- éå®˜æ–¹ Green Cardï¼Œ[PDF ä¸‹è½½é“¾æ¥](https://inst.eecs.berkeley.edu/~cs61c/fa17/img/riscvcard.pdf)

### RISC-V C and C++ Cross-compiler

- https://github.com/riscv-collab/riscv-gnu-toolchain æ ¹æ®è¯¥ Repo æ•™ç¨‹å®‰è£…
- è¯·æ³¨æ„ä¸‹è½½éœ€è¦ 6.6G ç©ºé—´ï¼Œå®‰è£…å†…å®¹å¤§å°ä¸º 1G å·¦å³ã€‚

### ä½¿ç”¨ FPGA æ¿è¿è¡Œä»£ç 

- **Vivado**

  - ä½ éœ€è¦è¯¥è½¯ä»¶å°† Verilog ä»£ç ç¼–è¯‘ä¸ºå¯ä»¥çƒ§å½•è‡³ FPGA æ¿çš„äºŒè¿›åˆ¶æ–‡ä»¶

  - Vivado å®‰è£…åè½¯ä»¶æ•´ä½“å¤§å°è¾¾ 30G å·¦å³ï¼Œè¯·å‡†å¤‡è¶³å¤Ÿç¡¬ç›˜ç©ºé—´

- **Serial Communication Library**

  - ç¨‹åºä¸ FPGA æ¿é€šè¿‡ USB é€šè®¯è¿‡ç¨‹ä¸­ä½¿ç”¨è¯¥åº“
  - å®‰è£…æ–¹å¼å‚è§æœ¬ä»“åº“ Submodule


